<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>7分 → 3分 自動タイマー</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#22c55e;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      background: linear-gradient(180deg, #071026 0%, #071b2e 100%);
      color:#e6eef8;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      box-sizing:border-box;
    }
    .card{
      width:100%;
      max-width:520px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:22px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.04);
    }
    h1{margin:0 0 8px 0; font-size:20px}
    p.sub{margin:0 0 18px 0; color:var(--muted); font-size:13px}
    .display{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      background:var(--glass);
      padding:18px;
      border-radius:10px;
      margin-bottom:18px;
    }
    .time{
      font-size:44px;
      font-weight:700;
      letter-spacing:1px;
    }
    .phase{text-align:right;}
    .small{font-size:13px; color:var(--muted)}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      appearance:none;
      border:0;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    .btn-start{background:linear-gradient(90deg,#16a34a,#22c55e); color:#021214}
    .btn-stop{background:#e11d48; color:#fff}
    .btn-pause{background:#f59e0b; color:#021214}
    .btn-reset{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:8px 10px}
    .progress{
      height:8px;
      background: rgba(255,255,255,0.04);
      border-radius:999px;
      overflow:hidden;
      margin-top:12px;
    }
    .progress > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg,#22c55e,#06b6d4);
      transition: width 0.15s linear;
    }
    footer{margin-top:12px; color:var(--muted); font-size:12px; text-align:right}
    @media (max-width:420px){
      .time{font-size:36px}
      .card{padding:16px}
    }
  </style>
</head>
<body>
  <div class="card" role="application" aria-labelledby="title">
    <h1 id="title">7分 → 3分 自動タイマー</h1>
    <p class="sub">スタートで7分→アラーム→3分→アラーム。終了3秒前からcount.mp3でカウントします。</p>

    <div class="display" aria-live="polite">
      <div>
        <div class="time" id="time">07:00</div>
        <div class="small" id="desc">停止中</div>
      </div>
      <div class="phase" aria-hidden="true">
        <div class="small">フェーズ</div>
        <div id="phaseLabel" style="font-weight:700; margin-top:6px">—</div>
      </div>
    </div>

    <div class="progress" aria-hidden="true" title="進捗">
      <i id="progressBar" style="width:0%"></i>
    </div>

    <div class="controls" style="margin-top:12px;">
      <button id="startBtn" class="btn-start">スタート</button>
      <button id="pauseBtn" class="btn-pause" disabled>一時停止</button>
      <button id="stopBtn" class="btn-stop" disabled>停止</button>
      <button id="resetBtn" class="btn-reset">リセット</button>
    </div>

    <footer>Enter = スタート / Space = 一時停止 / Esc = 停止</footer>
  </div>

  <audio id="countSound" src="count.mp3"></audio>
  <audio id="alarmSound" src="pee.mp3"></audio>

  <script>
    const PHASES = [
      { seconds: 7 * 60, label: "7分タイマー" },
      { seconds: 3 * 60, label: "3分タイマー" }
    ];

    const timeEl = document.getElementById('time');
    const descEl = document.getElementById('desc');
    const phaseLabelEl = document.getElementById('phaseLabel');
    const progressBar = document.getElementById('progressBar');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const countSound = document.getElementById('countSound');
    const alarmSound = document.getElementById('alarmSound');

    let running = false, paused = false, phaseIndex = 0;
    let startTime = 0, pausedElapsed = 0, rafId = null;
    let lastRemaining = null;

    function formatTime(sec){
      sec = Math.max(0, Math.ceil(sec));
      const m = String(Math.floor(sec / 60)).padStart(2,'0');
      const s = String(sec % 60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function updateUI(remain, total){
      timeEl.textContent = formatTime(remain);
      phaseLabelEl.textContent = PHASES[phaseIndex]?.label ?? "—";
      descEl.textContent = running ? (paused ? "一時停止中" : "動作中") : "停止中";
      progressBar.style.width = `${(1 - remain / total) * 100}%`;
      startBtn.disabled = running && !paused;
      pauseBtn.disabled = !running;
      stopBtn.disabled = !running;
    }

    function getElapsed(){
      return paused ? pausedElapsed : (performance.now() - startTime) / 1000;
    }

    function getRemaining(){
      return PHASES[phaseIndex].seconds - getElapsed();
    }

    function playCountIfNeeded(remain){
      if ([3,2,1].includes(Math.ceil(remain)) && Math.ceil(remain) !== lastRemaining){
        countSound.currentTime = 0;
        countSound.play();
      }
      lastRemaining = Math.ceil(remain);
    }

    function animate(){
      const remain = getRemaining();
      const total = PHASES[phaseIndex].seconds;
      updateUI(remain, total);

      if(remain <= 0){
        alarmSound.currentTime = 0;
        alarmSound.play();
        if(phaseIndex + 1 < PHASES.length){
          phaseIndex++;
          startTime = performance.now();
          pausedElapsed = 0;
          lastRemaining = null;
          rafId = requestAnimationFrame(animate);
        } else {
          running = false;
          updateUI(0, total);
        }
        return;
      }

      playCountIfNeeded(remain);
      if(running && !paused) rafId = requestAnimationFrame(animate);
    }

    function startSequence(){
      if(running && !paused) return;
      if(!running){
        phaseIndex = 0;
        lastRemaining = null;
        startTime = performance.now();
        pausedElapsed = 0;
      } else if(paused){
        startTime = performance.now() - pausedElapsed * 1000;
        paused = false;
      }
      running = true;
      animate();
    }

    function pauseToggle(){
      if(!running) return;
      if(paused){
        startTime = performance.now() - pausedElapsed * 1000;
        paused = false;
        animate();
      } else {
        pausedElapsed = (performance.now() - startTime) / 1000;
        paused = true;
        cancelAnimationFrame(rafId);
      }
      updateUI(getRemaining(), PHASES[phaseIndex].seconds);
    }

    function stopAll(){
      running = false;
      paused = false;
      cancelAnimationFrame(rafId);
      updateUI(PHASES[0].seconds, PHASES[0].seconds);
    }

    function resetAll(){
      stopAll();
      phaseIndex = 0;
      pausedElapsed = 0;
      updateUI(PHASES[0].seconds, PHASES[0].seconds);
    }

    startBtn.onclick = () => startSequence();
    pauseBtn.onclick = () => pauseToggle();
    stopBtn.onclick = () => stopAll();
    resetBtn.onclick = () => resetAll();

    document.onkeydown = e => {
      if(e.key === "Enter") startBtn.click();
      else if(e.code === "Space"){ e.preventDefault(); pauseBtn.click(); }
      else if(e.key === "Escape") stopBtn.click();
    };

    resetAll();
  </script>
</body>
</html>
